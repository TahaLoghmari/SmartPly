# containerapp.yml

# yaml-language-server: $schema=https://raw.githubusercontent.com/Azure/azure-container-apps/main/docs/containerapp.json

properties:
  configuration:
    ingress:
      external: true
      targetPort: 80
  template:
    containers:
      - image: ${{ env.AZURE_CONTAINER_REGISTRY }}.azurecr.io/${{ env.CONTAINER_APP_NAME }}:${{ github.sha }}
        name: ${{ env.CONTAINER_APP_NAME }}
        env:
          - name: ASPNETCORE_ENVIRONMENT
            value: Production
          - name: ConnectionStrings__DefaultConnection
            secretRef: DEFAULT_CONNECTION
          - name: Jwt__Key
            secretRef: JWT_KEY
          - name: Jwt__Issuer
            secretRef: JWT_ISSUER
          - name: Jwt__Audience
            secretRef: JWT_AUDIENCE
          - name: Jwt__ExpirationInMinutes
            value: 15
          - name: Jwt__RefreshTokenExpirationDays
            value: 30
          - name: Google__ClientId
            secretRef: GOOGLE_CLIENT_ID
          - name: Google__ClientSecret
            secretRef: GOOGLE_CLIENT_SECRET
          - name: Google__RedirectUri
            secretRef: GOOGLE_REDIRECT_URI
          - name: Google__Scopes
            value: "openid email profile https://www.googleapis.com/auth/gmail.readonly"
          - name: EmailSettings__MailServer
            value: smtp.gmail.com
          - name: EmailSettings__MailPort
            value: 587
          - name: EmailSettings__SenderName
            value: SmartPly
          - name: EmailSettings__FromEmail
            value: medtahalog@gmail.com
          - name: EmailSettings__Password
            secretRef: EMAIL_SETTINGS_PASSWORD
          - name: Frontend__BaseUrl
            secretRef: FRONTEND_URL
          - name: Supabase__ServiceRoleKey
            secretRef: SUPABASE_SERVICE_ROLE_KEY
          - name: Supabase__Url
            secretRef: SUPABASE_URL
          - name: Gemini__Credentials__ApiKey
            secretRef: GEMINI_CREDENTIALS_API_KEY
          - name: Gemini__Model
            value: gemini-2.5-flash
        probes:
          - type: Liveness
            httpGet:
              path: "/health/live"
              port: 80
            periodSeconds: 10
            failureThreshold: 3
          - type: Readiness
            httpGet:
              path: "/health/ready"
              port: 80
            periodSeconds: 10
            failureThreshold: 3
          - type: Startup
            httpGet:
              path: "/health/startup"
              port: 80
            initialDelaySeconds: 5
            periodSeconds: 10
            failureThreshold: 3
    scale:
      minReplicas: 1
      maxReplicas: 1
  secrets:
    - name: DEFAULT_CONNECTION
      value: "${{ secrets.DEFAULT_CONNECTION }}"
    - name: JWT_KEY
      value: "${{ secrets.JWT_KEY }}"
    - name: JWT_ISSUER
      value: "${{ secrets.JWT_ISSUER }}"
    - name: JWT_AUDIENCE
      value: "${{ secrets.JWT_AUDIENCE }}"
    - name: GOOGLE_CLIENT_ID
      value: "${{ secrets.GOOGLE_CLIENT_ID }}"
    - name: GOOGLE_CLIENT_SECRET
      value: "${{ secrets.GOOGLE_CLIENT_SECRET }}"
    - name: GOOGLE_REDIRECT_URI
      value: "${{ secrets.GOOGLE_REDIRECT_URI }}"
    - name: EMAIL_SETTINGS_PASSWORD
      value: "${{ secrets.EMAIL_SETTINGS_PASSWORD }}"
    - name: FRONTEND_URL
      value: "${{ secrets.FRONTEND_URL }}"
    - name: SUPABASE_SERVICE_ROLE_KEY
      value: "${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}"
    - name: SUPABASE_URL
      value: "${{ secrets.SUPABASE_URL }}"
    - name: GEMINI_CREDENTIALS_API_KEY
      value: "${{ secrets.GEMINI_CREDENTIALS_API_KEY }}"
